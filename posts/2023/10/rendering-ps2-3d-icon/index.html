<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>使用Python和OpenGL渲染PS2存档3D图标 | 路边的阿不</title><meta name=keywords content="Playstation2,Python,OpenGL"><meta name=description content="经过前面一系列文章的铺垫，PS2存档3D图标的文件已经全部解析完毕。本篇开始将介绍使用如下工具将3D图标渲染出来，并尽可能接近PS2主机原生"><meta name=author content="路边的阿不"><link rel=canonical href=https://babyno.top/posts/2023/10/rendering-ps2-3d-icon/><meta name=google-site-verification content="G-W1K6MS6C1Z"><link crossorigin=anonymous href=/assets/css/stylesheet.5cfc680b1eeaeef9efbced92d46c2a9e876b72ee14fba85846afc4cff9e6e6f8.css integrity="sha256-XPxoCx7q7vnvvO2S1Gwqnodrcu4U+6hYRq/Ez/nm5vg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://babyno.top/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://babyno.top/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://babyno.top/favicon-32x32.png><link rel=apple-touch-icon href=https://babyno.top/apple-touch-icon.png><link rel=mask-icon href=https://babyno.top/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-21338538-2","auto"),ga("send","pageview"))</script><meta property="og:title" content="使用Python和OpenGL渲染PS2存档3D图标"><meta property="og:description" content="经过前面一系列文章的铺垫，PS2存档3D图标的文件已经全部解析完毕。本篇开始将介绍使用如下工具将3D图标渲染出来，并尽可能接近PS2主机原生"><meta property="og:type" content="article"><meta property="og:url" content="https://babyno.top/posts/2023/10/rendering-ps2-3d-icon/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-10-09T17:34:15+00:00"><meta property="article:modified_time" content="2023-10-09T17:34:15+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="使用Python和OpenGL渲染PS2存档3D图标"><meta name=twitter:description content="经过前面一系列文章的铺垫，PS2存档3D图标的文件已经全部解析完毕。本篇开始将介绍使用如下工具将3D图标渲染出来，并尽可能接近PS2主机原生"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://babyno.top/posts/"},{"@type":"ListItem","position":2,"name":"使用Python和OpenGL渲染PS2存档3D图标","item":"https://babyno.top/posts/2023/10/rendering-ps2-3d-icon/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"使用Python和OpenGL渲染PS2存档3D图标","name":"使用Python和OpenGL渲染PS2存档3D图标","description":"经过前面一系列文章的铺垫，PS2存档3D图标的文件已经全部解析完毕。本篇开始将介绍使用如下工具将3D图标渲染出来，并尽可能接近PS2主机原生","keywords":["Playstation2","Python","OpenGL"],"articleBody":" 经过前面一系列文章的铺垫，PS2存档3D图标的文件已经全部解析完毕。本篇开始将介绍使用如下工具将3D图标渲染出来，并尽可能接近PS2主机原生的效果。\nPython3 PyGame Numpy ModernGL PyGLM 01 初始化PyGame和ModernGL 第一步先初始化PyGame，设置窗口大小为640x480，FPS为60。开启OpenGL渲染模式，OpenGL的版本号设置为3.3。\nimport pygame as pg pg.init() pg.display.gl_set_attribute(pg.GL_CONTEXT_MAJOR_VERSION, 3) pg.display.gl_set_attribute(pg.GL_CONTEXT_MINOR_VERSION, 3) pg.display.gl_set_attribute(pg.GL_CONTEXT_PROFILE_MASK, pg.GL_CONTEXT_PROFILE_CORE) pg.display.set_mode((640, 480), flags=pg.OPENGL | pg.DOUBLEBUF) self.clock = pg.time.Clock() self.clock.tick(60) 接着初始化ModernGL，非常简单，只要创建一个context，开启深度测试和面剔除。\nimport moderngl as mgl self.ctx = mgl.create_context() self.ctx.enable(flags=mgl.DEPTH_TEST | mgl.CULL_FACE) 02 获取顶点、纹理、法线等数据 这部分内容在上一篇解析PS2游戏存档3D图标有详细描述，就不展开了，这里只贴一下icon.sys的数据结构供参考。\nstruct IconSys { char magic[4]; uint16 unknown; // ignore uint16 subtitle_line_break; uint16 unknown; // ignore uint32 bg_transparency; uint32 bg_color_upper_left[4]; uint32 bg_color_upper_right[4]; uint32 bg_color_lower_left[4]; uint32 bg_color_lower_right[4]; float32 light_pos1[4]; float32 light_pos2[4]; float32 light_pos3[4]; float32 light_color1[4]; float32 light_color2[4]; float32 light_color3[4]; float32 ambient[4]; char subtitle[68]; char icon_file_normal[64]; char icon_file_copy[64]; char icon_file_delete[64]; char zeros[512]; // ignore }; 03 坐标系统 这里以右手系统创建坐标系，但是原始的顶点是y轴颠倒的，如下图A。因此我们之后的工作将在转换后的图B坐标系下进行。 04 变换矩阵 观察矩阵 上图B中，摄像机位置在z轴的负延伸方向，我们稍稍向y轴负方向移动一小段距离，这样可以使视线不是对着图标的脚部，而是稍稍靠上一点，因此将摄像机位置坐标设为(0, -2, -10)。因为要将y轴颠倒，可以直接将摄像机向上的方向设置为y轴的负方向。这样一来lookAt矩阵创建如下：\nself.position = glm.vec3(0, -2, -10) self.up = glm.vec3(0, -1, 0) self.view = glm.lookAt(self.position, glm.vec3(0, -2, 0), self.up) 投影矩阵 投影矩阵可以用如下公式获得\nself.proj = glm.perspective(glm.radians(50), window_width / window_height, 0.1, 100) 模型矩阵 创建模型矩阵的目的是控制模型对象在3D空间中的位置变化，在这里模型对象需要在空间里绕着y轴做360度的旋转。\n# 初始化模型矩阵 self.m_model = glm.mat4() # 使模型绕y轴旋转，转过的角度为经过的时间。初始化的180度是为了让模型在开始的时候背对着画面，更接近PS2主机的行为 m_model = glm.rotate(self.m_model, glm.radians(180) + animation_time / 2, glm.vec3(0, 1, 0)) 05 创建着色器 这里一共需要创建四个着色器\n背景顶点着色器 背景片段着色器 Icon顶点着色器 Icon片段着色器 背景着色器 背景着色器比较简单，只要创建一个覆盖整个坐标系的矩形，并且设置在离摄像机最远的那个坐标平面上即可。参考上面的图B，这个平面应该是z轴的0.9999。这个矩形的四个顶点的坐标分别为(-1, 1), (-1, -1), (1, -1), (1, 1)，对应的颜色在icon.sys中可以解析出来。根据这四个顶点和颜色，就可以构建背景VBO及VAO，这里不做过多描述。\n// bg.vert #version 330 core in vec2 vertexPos; in vec4 vertexColor; out vec3 fragColor0; void main() { fragColor0 = vertexColor.rgb; gl_Position = vec4(vertexPos.xy, 0.9999, 1.0); } // bg.frag #version 330 core in vec3 fragColor0; out vec4 fragColor; uniform float alpha0; void main() { fragColor = vec4(fragColor0, alpha0); } Icon着色器 Icon着色器会比较复杂，我们先尝试着把Icon顶点渲染出来。还记得每个图标有多个形状吗？形状与动画相关，我们现在只取其中的一个形状组成VBO和VAO。\n// icon.vert #version 330 core in vec4 vertexPos; uniform mat4 proj; uniform mat4 view; uniform mat4 model; void main() { gl_Position = proj * view * model * vec4(vertexPos.xyz, 1); } // icon.frag #version 330 core out vec4 fragColor; void main() { fragColor = vec4(0, 0, 0, 1); } 以下是运行代码后的效果：\n添加纹理 在上面的基础上，引入纹理坐标和纹理数据。\n// icon.vert #version 330 core in vec4 vertexPos; in vec2 texCoord; in vec4 vertexColor; out vec4 fragColor0; out vec2 uv0; uniform mat4 proj; uniform mat4 view; uniform mat4 model; void main() { uv0 = texCoord; fragColor0 = vertexColor; gl_Position = proj * view * model * vec4(vertexPos.xyz, 1); } // icon.frag #version 330 core in vec2 uv0; in vec4 fragColor0; out vec4 fragColor; uniform sampler2D texture0; void main() { float alpha = fragColor0.a; vec3 color = fragColor0.rgb * texture(texture0, uv0).rgb; fragColor = vec4(color, alpha); } 添加光照 在上面的基础上，引入光源，环境光以及法线数据。\n// icon.vert #version 330 core in vec4 vertexPos; in vec2 texCoord; in vec4 vertexColor; in vec4 normal; out vec4 fragColor0; out vec2 uv0; out vec3 normal0; out vec3 fragPos0; uniform mat4 proj; uniform mat4 view; uniform mat4 model; void main() { uv0 = texCoord; fragColor0 = vertexColor; normal0 = mat3(model) * normalize(normal.xyz); gl_Position = proj * view * model * vec4(vertexPos.xyz, 1); fragPos0 = gl_Position.xyz; } // icon.frag #version 330 core #define MAX_NUM_TOTAL_LIGHTS 3 in vec2 uv0; in vec4 fragColor0; in vec3 normal0; in vec3 fragPos0; out vec4 fragColor; struct Light { vec4 pos; vec4 color; }; uniform sampler2D texture0; uniform vec4 ambient; uniform Light lights[MAX_NUM_TOTAL_LIGHTS]; void main() { vec3 normal = normalize(normal0); float alpha = fragColor0.a; vec3 color = fragColor0.rgb * texture(texture0, uv0).rgb; vec3 diffuse = vec3(0.0, 0.0, 0.0); for (int i = 0; i \u003c MAX_NUM_TOTAL_LIGHTS; i++) { vec3 lightDir = normalize(lights[i].pos.xyz - fragPos0); float diff = max(dot(lightDir, normal), 0.0); diffuse += diff * lights[i].color.rgb; } color = (ambient.rgb + diffuse) * color; fragColor = vec4(color, alpha); } 动画效果 动画效果是让着色器按照时间渲染不同形状的顶点数据。我们可以设计一个计时器和一个计数器，以确定当前时间应该渲染哪个形状的顶点。\nframe_length 完成动画效果需要的实际帧数，实际帧率等于60FPS animation_time 动画运行时间 anim_speed 动画播放速度 frame_length / animation_shapes 一个形状包含多少帧 animation_time = time.time() - self.start_time curr_frame = int(animation_time * self.window.fps * self.icon.anim_speed) % self.icon.frame_length curr_shape = int(curr_frame // (self.icon.frame_length / self.icon.animation_shapes)) 使动画平滑过渡 使动画平滑过渡需要使用着色器的顶点插值技术。我们在发送着色器顶点的时候，将当前形状和下一个形状的顶点数据同时发送。这样再根据时间因子，着色器会自动计算两个形状之间的顶点。\ntween_factor 计算当前时间戳在整个形状中所占帧的百分比 curr_frame_in_shape = curr_frame % frames_in_shape / frames_in_shape tween_factor = glm.float32(curr_frame_in_shape) // icon.vert #version 330 core in vec4 vertexPos; in vec2 texCoord; in vec4 vertexColor; in vec4 nextVertexPos; in vec4 normal; out vec4 fragColor0; out vec2 uv0; out vec3 normal0; out vec3 fragPos0; uniform mat4 proj; uniform mat4 view; uniform mat4 model; uniform float tweenFactor; void main() { uv0 = texCoord; fragColor0 = vertexColor; normal0 = mat3(model) * normalize(normal.xyz); vec4 basePos = vec4(mix(vertexPos.xyz, nextVertexPos.xyz, tweenFactor), 1.0); gl_Position = proj * view * model * basePos; fragPos0 = gl_Position.xyz; } // icon.frag #version 330 core #define MAX_NUM_TOTAL_LIGHTS 3 in vec2 uv0; in vec4 fragColor0; in vec3 normal0; in vec3 fragPos0; out vec4 fragColor; struct Light { vec4 pos; vec4 color; }; uniform sampler2D texture0; uniform vec4 ambient; uniform Light lights[MAX_NUM_TOTAL_LIGHTS]; void main() { vec3 normal = normalize(normal0); float alpha = fragColor0.a; vec3 color = fragColor0.rgb * texture(texture0, uv0).rgb; vec3 diffuse = vec3(0.0, 0.0, 0.0); for (int i = 0; i \u003c MAX_NUM_TOTAL_LIGHTS; i++) { vec3 lightDir = normalize(lights[i].pos.xyz - fragPos0); float diff = max(dot(lightDir, normal), 0.0); diffuse += diff * lights[i].color.rgb; } color = (ambient.rgb + diffuse) * color; fragColor = vec4(color, alpha); } 最终效果：\n06 尾声 所有代码均可在 https://github.com/caol64/ps2mc-browser 下载到。在我的第一篇文章中，我也提到了这个系列的创作初衷：为了纪念逝去的青春，以及对技术永不磨灭的热情。\n07 参考文献 gothi - icon.sys format Martin Akesson - PS2 Icon Format v0.5 Florian Märkl - mymcplus Ross Ridge - PlayStation 2 Memory Card File System ","wordCount":"2004","inLanguage":"en","datePublished":"2023-10-09T17:34:15Z","dateModified":"2023-10-09T17:34:15Z","author":{"@type":"Person","name":"路边的阿不"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://babyno.top/posts/2023/10/rendering-ps2-3d-icon/"},"publisher":{"@type":"Organization","name":"路边的阿不","logo":{"@type":"ImageObject","url":"https://babyno.top/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://babyno.top/ accesskey=h title="路边的阿不 (Alt + H)">路边的阿不</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://babyno.top/archive/ title=Archive><span>Archive</span></a></li><li><a href=https://babyno.top/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://babyno.top/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://babyno.top/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://babyno.top/>Home</a>&nbsp;»&nbsp;<a href=https://babyno.top/posts/>Posts</a></div><h1 class=post-title>使用Python和OpenGL渲染PS2存档3D图标</h1><div class=post-meta><span title='2023-10-09 17:34:15 +0000 UTC'>2023-10-09 17:34:15</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;路边的阿不</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#01-%e5%88%9d%e5%a7%8b%e5%8c%96pygame%e5%92%8cmoderngl aria-label="01 初始化PyGame和ModernGL">01 初始化<code>PyGame</code>和<code>ModernGL</code></a></li><li><a href=#02-%e8%8e%b7%e5%8f%96%e9%a1%b6%e7%82%b9%e7%ba%b9%e7%90%86%e6%b3%95%e7%ba%bf%e7%ad%89%e6%95%b0%e6%8d%ae aria-label="02 获取顶点、纹理、法线等数据">02 获取顶点、纹理、法线等数据</a></li><li><a href=#03-%e5%9d%90%e6%a0%87%e7%b3%bb%e7%bb%9f aria-label="03 坐标系统">03 坐标系统</a></li><li><a href=#04-%e5%8f%98%e6%8d%a2%e7%9f%a9%e9%98%b5 aria-label="04 变换矩阵">04 变换矩阵</a><ul><li><a href=#%e8%a7%82%e5%af%9f%e7%9f%a9%e9%98%b5 aria-label=观察矩阵>观察矩阵</a></li><li><a href=#%e6%8a%95%e5%bd%b1%e7%9f%a9%e9%98%b5 aria-label=投影矩阵>投影矩阵</a></li><li><a href=#%e6%a8%a1%e5%9e%8b%e7%9f%a9%e9%98%b5 aria-label=模型矩阵>模型矩阵</a></li></ul></li><li><a href=#05-%e5%88%9b%e5%bb%ba%e7%9d%80%e8%89%b2%e5%99%a8 aria-label="05 创建着色器">05 创建着色器</a><ul><li><a href=#%e8%83%8c%e6%99%af%e7%9d%80%e8%89%b2%e5%99%a8 aria-label=背景着色器>背景着色器</a></li><li><a href=#icon%e7%9d%80%e8%89%b2%e5%99%a8 aria-label=Icon着色器>Icon着色器</a></li><li><a href=#%e6%b7%bb%e5%8a%a0%e7%ba%b9%e7%90%86 aria-label=添加纹理>添加纹理</a></li><li><a href=#%e6%b7%bb%e5%8a%a0%e5%85%89%e7%85%a7 aria-label=添加光照>添加光照</a></li><li><a href=#%e5%8a%a8%e7%94%bb%e6%95%88%e6%9e%9c aria-label=动画效果>动画效果</a></li><li><a href=#%e4%bd%bf%e5%8a%a8%e7%94%bb%e5%b9%b3%e6%bb%91%e8%bf%87%e6%b8%a1 aria-label=使动画平滑过渡>使动画平滑过渡</a></li></ul></li><li><a href=#06-%e5%b0%be%e5%a3%b0 aria-label="06 尾声">06 尾声</a></li><li><a href=#07-%e5%8f%82%e8%80%83%e6%96%87%e7%8c%ae aria-label="07 参考文献">07 参考文献</a></li></ul></div></details></div><div class=post-content><p><img loading=lazy src=/static/imgs/posts/2023-10-09-rendering-ps2-3d-icon/1.jpg alt></p><p>经过前面一系列文章的铺垫，PS2存档3D图标的文件已经全部解析完毕。本篇开始将介绍使用如下工具将3D图标渲染出来，并尽可能接近PS2主机原生的效果。</p><ul><li>Python3</li><li>PyGame</li><li>Numpy</li><li>ModernGL</li><li>PyGLM</li></ul><h2 id=01-初始化pygame和moderngl>01 初始化<code>PyGame</code>和<code>ModernGL</code><a hidden class=anchor aria-hidden=true href=#01-初始化pygame和moderngl>#</a></h2><p>第一步先初始化<code>PyGame</code>，设置窗口大小为<code>640x480</code>，<code>FPS</code>为<code>60</code>。开启<code>OpenGL</code>渲染模式，<code>OpenGL</code>的版本号设置为<code>3.3</code>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> pygame <span style=color:#66d9ef>as</span> pg
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pg<span style=color:#f92672>.</span>init()
</span></span><span style=display:flex><span>pg<span style=color:#f92672>.</span>display<span style=color:#f92672>.</span>gl_set_attribute(pg<span style=color:#f92672>.</span>GL_CONTEXT_MAJOR_VERSION, <span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>pg<span style=color:#f92672>.</span>display<span style=color:#f92672>.</span>gl_set_attribute(pg<span style=color:#f92672>.</span>GL_CONTEXT_MINOR_VERSION, <span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>pg<span style=color:#f92672>.</span>display<span style=color:#f92672>.</span>gl_set_attribute(pg<span style=color:#f92672>.</span>GL_CONTEXT_PROFILE_MASK, pg<span style=color:#f92672>.</span>GL_CONTEXT_PROFILE_CORE)
</span></span><span style=display:flex><span>pg<span style=color:#f92672>.</span>display<span style=color:#f92672>.</span>set_mode((<span style=color:#ae81ff>640</span>, <span style=color:#ae81ff>480</span>), flags<span style=color:#f92672>=</span>pg<span style=color:#f92672>.</span>OPENGL <span style=color:#f92672>|</span> pg<span style=color:#f92672>.</span>DOUBLEBUF)
</span></span><span style=display:flex><span>self<span style=color:#f92672>.</span>clock <span style=color:#f92672>=</span> pg<span style=color:#f92672>.</span>time<span style=color:#f92672>.</span>Clock()
</span></span><span style=display:flex><span>self<span style=color:#f92672>.</span>clock<span style=color:#f92672>.</span>tick(<span style=color:#ae81ff>60</span>)
</span></span></code></pre></div><p>接着初始化<code>ModernGL</code>，非常简单，只要创建一个<code>context</code>，开启深度测试和面剔除。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> moderngl <span style=color:#66d9ef>as</span> mgl
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>self<span style=color:#f92672>.</span>ctx <span style=color:#f92672>=</span> mgl<span style=color:#f92672>.</span>create_context()
</span></span><span style=display:flex><span>self<span style=color:#f92672>.</span>ctx<span style=color:#f92672>.</span>enable(flags<span style=color:#f92672>=</span>mgl<span style=color:#f92672>.</span>DEPTH_TEST <span style=color:#f92672>|</span> mgl<span style=color:#f92672>.</span>CULL_FACE)
</span></span></code></pre></div><h2 id=02-获取顶点纹理法线等数据>02 获取顶点、纹理、法线等数据<a hidden class=anchor aria-hidden=true href=#02-获取顶点纹理法线等数据>#</a></h2><p>这部分内容在上一篇<a href>解析PS2游戏存档3D图标</a>有详细描述，就不展开了，这里只贴一下<code>icon.sys</code>的数据结构供参考。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>IconSys</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> magic[<span style=color:#ae81ff>4</span>];
</span></span><span style=display:flex><span>    uint16 unknown; <span style=color:#75715e>// ignore
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    uint16 subtitle_line_break;
</span></span><span style=display:flex><span>    uint16 unknown; <span style=color:#75715e>// ignore
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    uint32 bg_transparency;
</span></span><span style=display:flex><span>    uint32 bg_color_upper_left[<span style=color:#ae81ff>4</span>];
</span></span><span style=display:flex><span>    uint32 bg_color_upper_right[<span style=color:#ae81ff>4</span>];
</span></span><span style=display:flex><span>    uint32 bg_color_lower_left[<span style=color:#ae81ff>4</span>];
</span></span><span style=display:flex><span>    uint32 bg_color_lower_right[<span style=color:#ae81ff>4</span>];
</span></span><span style=display:flex><span>    float32 light_pos1[<span style=color:#ae81ff>4</span>];
</span></span><span style=display:flex><span>    float32 light_pos2[<span style=color:#ae81ff>4</span>];
</span></span><span style=display:flex><span>    float32 light_pos3[<span style=color:#ae81ff>4</span>];
</span></span><span style=display:flex><span>    float32 light_color1[<span style=color:#ae81ff>4</span>];
</span></span><span style=display:flex><span>    float32 light_color2[<span style=color:#ae81ff>4</span>];
</span></span><span style=display:flex><span>    float32 light_color3[<span style=color:#ae81ff>4</span>];
</span></span><span style=display:flex><span>    float32 ambient[<span style=color:#ae81ff>4</span>];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> subtitle[<span style=color:#ae81ff>68</span>];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> icon_file_normal[<span style=color:#ae81ff>64</span>];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> icon_file_copy[<span style=color:#ae81ff>64</span>];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> icon_file_delete[<span style=color:#ae81ff>64</span>];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> zeros[<span style=color:#ae81ff>512</span>]; <span style=color:#75715e>// ignore
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>};
</span></span></code></pre></div><h2 id=03-坐标系统>03 坐标系统<a hidden class=anchor aria-hidden=true href=#03-坐标系统>#</a></h2><p>这里以右手系统创建坐标系，但是原始的顶点是y轴颠倒的，如下图A。因此我们之后的工作将在转换后的图B坐标系下进行。
<img loading=lazy src=/static/imgs/posts/2023-10-09-rendering-ps2-3d-icon/%E5%AD%98%E5%82%A8%E5%8D%A1-%E5%9D%90%E6%A0%87%E7%B3%BB.jpg alt></p><h2 id=04-变换矩阵>04 变换矩阵<a hidden class=anchor aria-hidden=true href=#04-变换矩阵>#</a></h2><h3 id=观察矩阵>观察矩阵<a hidden class=anchor aria-hidden=true href=#观察矩阵>#</a></h3><p>上图B中，摄像机位置在z轴的负延伸方向，我们稍稍向y轴负方向移动一小段距离，这样可以使视线不是对着图标的脚部，而是稍稍靠上一点，因此将摄像机位置坐标设为<code>(0, -2, -10)</code>。因为要将y轴颠倒，可以直接将摄像机向上的方向设置为y轴的负方向。这样一来<code>lookAt</code>矩阵创建如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>self<span style=color:#f92672>.</span>position <span style=color:#f92672>=</span> glm<span style=color:#f92672>.</span>vec3(<span style=color:#ae81ff>0</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>2</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>10</span>)
</span></span><span style=display:flex><span>self<span style=color:#f92672>.</span>up <span style=color:#f92672>=</span> glm<span style=color:#f92672>.</span>vec3(<span style=color:#ae81ff>0</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>self<span style=color:#f92672>.</span>view <span style=color:#f92672>=</span> glm<span style=color:#f92672>.</span>lookAt(self<span style=color:#f92672>.</span>position, glm<span style=color:#f92672>.</span>vec3(<span style=color:#ae81ff>0</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>0</span>), self<span style=color:#f92672>.</span>up)
</span></span></code></pre></div><h3 id=投影矩阵>投影矩阵<a hidden class=anchor aria-hidden=true href=#投影矩阵>#</a></h3><p>投影矩阵可以用如下公式获得</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>self<span style=color:#f92672>.</span>proj <span style=color:#f92672>=</span> glm<span style=color:#f92672>.</span>perspective(glm<span style=color:#f92672>.</span>radians(<span style=color:#ae81ff>50</span>), window_width <span style=color:#f92672>/</span> window_height, <span style=color:#ae81ff>0.1</span>, <span style=color:#ae81ff>100</span>)
</span></span></code></pre></div><h3 id=模型矩阵>模型矩阵<a hidden class=anchor aria-hidden=true href=#模型矩阵>#</a></h3><p>创建模型矩阵的目的是控制模型对象在3D空间中的位置变化，在这里模型对象需要在空间里绕着y轴做360度的旋转。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 初始化模型矩阵</span>
</span></span><span style=display:flex><span>self<span style=color:#f92672>.</span>m_model <span style=color:#f92672>=</span> glm<span style=color:#f92672>.</span>mat4()
</span></span><span style=display:flex><span><span style=color:#75715e># 使模型绕y轴旋转，转过的角度为经过的时间。初始化的180度是为了让模型在开始的时候背对着画面，更接近PS2主机的行为</span>
</span></span><span style=display:flex><span>m_model <span style=color:#f92672>=</span> glm<span style=color:#f92672>.</span>rotate(self<span style=color:#f92672>.</span>m_model, glm<span style=color:#f92672>.</span>radians(<span style=color:#ae81ff>180</span>) <span style=color:#f92672>+</span> animation_time <span style=color:#f92672>/</span> <span style=color:#ae81ff>2</span>, glm<span style=color:#f92672>.</span>vec3(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>0</span>))
</span></span></code></pre></div><h2 id=05-创建着色器>05 创建着色器<a hidden class=anchor aria-hidden=true href=#05-创建着色器>#</a></h2><p>这里一共需要创建四个着色器</p><ul><li>背景顶点着色器</li><li>背景片段着色器</li><li>Icon顶点着色器</li><li>Icon片段着色器</li></ul><h3 id=背景着色器>背景着色器<a hidden class=anchor aria-hidden=true href=#背景着色器>#</a></h3><p>背景着色器比较简单，只要创建一个覆盖整个坐标系的矩形，并且设置在离摄像机最远的那个坐标平面上即可。参考上面的图B，这个平面应该是z轴的0.9999。这个矩形的四个顶点的坐标分别为(-1, 1), (-1, -1), (1, -1), (1, 1)，对应的颜色在<code>icon.sys</code>中可以解析出来。根据这四个顶点和颜色，就可以构建背景VBO及VAO，这里不做过多描述。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-glsl data-lang=glsl><span style=display:flex><span><span style=color:#75715e>// bg.vert</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#version 330 core</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span> <span style=color:#66d9ef>vec2</span> vertexPos;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span> <span style=color:#66d9ef>vec4</span> vertexColor;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>out</span> <span style=color:#66d9ef>vec3</span> fragColor0;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> main() {
</span></span><span style=display:flex><span>    fragColor0 <span style=color:#f92672>=</span> vertexColor.rgb;
</span></span><span style=display:flex><span>    gl_Position <span style=color:#f92672>=</span> <span style=color:#66d9ef>vec4</span>(vertexPos.xy, <span style=color:#ae81ff>0.9999</span>, <span style=color:#ae81ff>1.0</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-glsl data-lang=glsl><span style=display:flex><span><span style=color:#75715e>// bg.frag</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#version 330 core</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span> <span style=color:#66d9ef>vec3</span> fragColor0;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>out</span> <span style=color:#66d9ef>vec4</span> fragColor;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>uniform</span> <span style=color:#66d9ef>float</span> alpha0;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> main() {
</span></span><span style=display:flex><span>    fragColor <span style=color:#f92672>=</span> <span style=color:#66d9ef>vec4</span>(fragColor0, alpha0);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=icon着色器>Icon着色器<a hidden class=anchor aria-hidden=true href=#icon着色器>#</a></h3><p>Icon着色器会比较复杂，我们先尝试着把Icon顶点渲染出来。还记得每个图标有多个形状吗？形状与动画相关，我们现在只取其中的一个形状组成VBO和VAO。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-glsl data-lang=glsl><span style=display:flex><span><span style=color:#75715e>// icon.vert</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#version 330 core</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span> <span style=color:#66d9ef>vec4</span> vertexPos;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>uniform</span> mat4 proj;
</span></span><span style=display:flex><span><span style=color:#66d9ef>uniform</span> mat4 view;
</span></span><span style=display:flex><span><span style=color:#66d9ef>uniform</span> mat4 model;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> main() {
</span></span><span style=display:flex><span>    gl_Position <span style=color:#f92672>=</span> proj <span style=color:#f92672>*</span> view <span style=color:#f92672>*</span> model <span style=color:#f92672>*</span> <span style=color:#66d9ef>vec4</span>(vertexPos.xyz, <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-glsl data-lang=glsl><span style=display:flex><span><span style=color:#75715e>// icon.frag</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#version 330 core</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>out</span> <span style=color:#66d9ef>vec4</span> fragColor;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> main() {
</span></span><span style=display:flex><span>    fragColor <span style=color:#f92672>=</span> <span style=color:#66d9ef>vec4</span>(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>以下是运行代码后的效果：</p><p><img loading=lazy src=/static/imgs/posts/2023-10-09-rendering-ps2-3d-icon/3.gif alt></p><h3 id=添加纹理>添加纹理<a hidden class=anchor aria-hidden=true href=#添加纹理>#</a></h3><p>在上面的基础上，引入纹理坐标和纹理数据。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-glsl data-lang=glsl><span style=display:flex><span><span style=color:#75715e>// icon.vert</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#version 330 core</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span> <span style=color:#66d9ef>vec4</span> vertexPos;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span> <span style=color:#66d9ef>vec2</span> texCoord;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span> <span style=color:#66d9ef>vec4</span> vertexColor;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>out</span> <span style=color:#66d9ef>vec4</span> fragColor0;
</span></span><span style=display:flex><span><span style=color:#66d9ef>out</span> <span style=color:#66d9ef>vec2</span> uv0;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>uniform</span> mat4 proj;
</span></span><span style=display:flex><span><span style=color:#66d9ef>uniform</span> mat4 view;
</span></span><span style=display:flex><span><span style=color:#66d9ef>uniform</span> mat4 model;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> main() {
</span></span><span style=display:flex><span>    uv0 <span style=color:#f92672>=</span> texCoord;
</span></span><span style=display:flex><span>    fragColor0 <span style=color:#f92672>=</span> vertexColor;
</span></span><span style=display:flex><span>    gl_Position <span style=color:#f92672>=</span> proj <span style=color:#f92672>*</span> view <span style=color:#f92672>*</span> model <span style=color:#f92672>*</span> <span style=color:#66d9ef>vec4</span>(vertexPos.xyz, <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-glsl data-lang=glsl><span style=display:flex><span><span style=color:#75715e>// icon.frag</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#version 330 core</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span> <span style=color:#66d9ef>vec2</span> uv0;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span> <span style=color:#66d9ef>vec4</span> fragColor0;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>out</span> <span style=color:#66d9ef>vec4</span> fragColor;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>uniform</span> <span style=color:#66d9ef>sampler2D</span> texture0;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> main() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>float</span> alpha <span style=color:#f92672>=</span> fragColor0.a;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>vec3</span> color <span style=color:#f92672>=</span> fragColor0.rgb <span style=color:#f92672>*</span> texture(texture0, uv0).rgb;
</span></span><span style=display:flex><span>    fragColor <span style=color:#f92672>=</span> <span style=color:#66d9ef>vec4</span>(color, alpha);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><img loading=lazy src=/static/imgs/posts/2023-10-09-rendering-ps2-3d-icon/4.gif alt></p><h3 id=添加光照>添加光照<a hidden class=anchor aria-hidden=true href=#添加光照>#</a></h3><p>在上面的基础上，引入光源，环境光以及法线数据。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-glsl data-lang=glsl><span style=display:flex><span><span style=color:#75715e>// icon.vert</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#version 330 core</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span> <span style=color:#66d9ef>vec4</span> vertexPos;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span> <span style=color:#66d9ef>vec2</span> texCoord;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span> <span style=color:#66d9ef>vec4</span> vertexColor;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span> <span style=color:#66d9ef>vec4</span> normal;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>out</span> <span style=color:#66d9ef>vec4</span> fragColor0;
</span></span><span style=display:flex><span><span style=color:#66d9ef>out</span> <span style=color:#66d9ef>vec2</span> uv0;
</span></span><span style=display:flex><span><span style=color:#66d9ef>out</span> <span style=color:#66d9ef>vec3</span> normal0;
</span></span><span style=display:flex><span><span style=color:#66d9ef>out</span> <span style=color:#66d9ef>vec3</span> fragPos0;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>uniform</span> mat4 proj;
</span></span><span style=display:flex><span><span style=color:#66d9ef>uniform</span> mat4 view;
</span></span><span style=display:flex><span><span style=color:#66d9ef>uniform</span> mat4 model;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> main() {
</span></span><span style=display:flex><span>    uv0 <span style=color:#f92672>=</span> texCoord;
</span></span><span style=display:flex><span>    fragColor0 <span style=color:#f92672>=</span> vertexColor;
</span></span><span style=display:flex><span>    normal0 <span style=color:#f92672>=</span> mat3(model) <span style=color:#f92672>*</span> normalize(normal.xyz);
</span></span><span style=display:flex><span>    gl_Position <span style=color:#f92672>=</span> proj <span style=color:#f92672>*</span> view <span style=color:#f92672>*</span> model <span style=color:#f92672>*</span> <span style=color:#66d9ef>vec4</span>(vertexPos.xyz, <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>    fragPos0 <span style=color:#f92672>=</span> gl_Position.xyz;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-glsl data-lang=glsl><span style=display:flex><span><span style=color:#75715e>// icon.frag</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#version 330 core</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define MAX_NUM_TOTAL_LIGHTS 3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span> <span style=color:#66d9ef>vec2</span> uv0;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span> <span style=color:#66d9ef>vec4</span> fragColor0;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span> <span style=color:#66d9ef>vec3</span> normal0;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span> <span style=color:#66d9ef>vec3</span> fragPos0;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>out</span> <span style=color:#66d9ef>vec4</span> fragColor;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> Light {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>vec4</span> pos;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>vec4</span> color;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>uniform</span> <span style=color:#66d9ef>sampler2D</span> texture0;
</span></span><span style=display:flex><span><span style=color:#66d9ef>uniform</span> <span style=color:#66d9ef>vec4</span> ambient;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>uniform</span> Light lights[MAX_NUM_TOTAL_LIGHTS];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> main() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>vec3</span> normal <span style=color:#f92672>=</span> normalize(normal0);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>float</span> alpha <span style=color:#f92672>=</span> fragColor0.a;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>vec3</span> color <span style=color:#f92672>=</span> fragColor0.rgb <span style=color:#f92672>*</span> texture(texture0, uv0).rgb;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>vec3</span> diffuse <span style=color:#f92672>=</span> <span style=color:#66d9ef>vec3</span>(<span style=color:#ae81ff>0.0</span>, <span style=color:#ae81ff>0.0</span>, <span style=color:#ae81ff>0.0</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> MAX_NUM_TOTAL_LIGHTS; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>vec3</span> lightDir <span style=color:#f92672>=</span> normalize(lights[i].pos.xyz <span style=color:#f92672>-</span> fragPos0);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>float</span> diff <span style=color:#f92672>=</span> max(dot(lightDir, normal), <span style=color:#ae81ff>0.0</span>);
</span></span><span style=display:flex><span>        diffuse <span style=color:#f92672>+=</span> diff <span style=color:#f92672>*</span> lights[i].color.rgb;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    color <span style=color:#f92672>=</span> (ambient.rgb <span style=color:#f92672>+</span> diffuse) <span style=color:#f92672>*</span> color;
</span></span><span style=display:flex><span>    fragColor <span style=color:#f92672>=</span> <span style=color:#66d9ef>vec4</span>(color, alpha);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><img loading=lazy src=/static/imgs/posts/2023-10-09-rendering-ps2-3d-icon/5.gif alt></p><h3 id=动画效果>动画效果<a hidden class=anchor aria-hidden=true href=#动画效果>#</a></h3><p>动画效果是让着色器按照时间渲染不同形状的顶点数据。我们可以设计一个计时器和一个计数器，以确定当前时间应该渲染哪个形状的顶点。</p><ul><li>frame_length 完成动画效果需要的实际帧数，实际帧率等于60FPS</li><li>animation_time 动画运行时间</li><li>anim_speed 动画播放速度</li><li>frame_length / animation_shapes 一个形状包含多少帧</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>animation_time <span style=color:#f92672>=</span> time<span style=color:#f92672>.</span>time() <span style=color:#f92672>-</span> self<span style=color:#f92672>.</span>start_time
</span></span><span style=display:flex><span>curr_frame <span style=color:#f92672>=</span> int(animation_time <span style=color:#f92672>*</span> self<span style=color:#f92672>.</span>window<span style=color:#f92672>.</span>fps <span style=color:#f92672>*</span> self<span style=color:#f92672>.</span>icon<span style=color:#f92672>.</span>anim_speed) <span style=color:#f92672>%</span> self<span style=color:#f92672>.</span>icon<span style=color:#f92672>.</span>frame_length
</span></span><span style=display:flex><span>curr_shape <span style=color:#f92672>=</span> int(curr_frame <span style=color:#f92672>//</span> (self<span style=color:#f92672>.</span>icon<span style=color:#f92672>.</span>frame_length <span style=color:#f92672>/</span> self<span style=color:#f92672>.</span>icon<span style=color:#f92672>.</span>animation_shapes))
</span></span></code></pre></div><p><img loading=lazy src=/static/imgs/posts/2023-10-09-rendering-ps2-3d-icon/6.gif alt></p><h3 id=使动画平滑过渡>使动画平滑过渡<a hidden class=anchor aria-hidden=true href=#使动画平滑过渡>#</a></h3><p>使动画平滑过渡需要使用着色器的顶点插值技术。我们在发送着色器顶点的时候，将当前形状和下一个形状的顶点数据同时发送。这样再根据时间因子，着色器会自动计算两个形状之间的顶点。</p><ul><li>tween_factor 计算当前时间戳在整个形状中所占帧的百分比</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>curr_frame_in_shape <span style=color:#f92672>=</span> curr_frame <span style=color:#f92672>%</span> frames_in_shape <span style=color:#f92672>/</span> frames_in_shape
</span></span><span style=display:flex><span>tween_factor <span style=color:#f92672>=</span> glm<span style=color:#f92672>.</span>float32(curr_frame_in_shape)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-glsl data-lang=glsl><span style=display:flex><span><span style=color:#75715e>// icon.vert</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#version 330 core</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span> <span style=color:#66d9ef>vec4</span> vertexPos;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span> <span style=color:#66d9ef>vec2</span> texCoord;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span> <span style=color:#66d9ef>vec4</span> vertexColor;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span> <span style=color:#66d9ef>vec4</span> nextVertexPos;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span> <span style=color:#66d9ef>vec4</span> normal;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>out</span> <span style=color:#66d9ef>vec4</span> fragColor0;
</span></span><span style=display:flex><span><span style=color:#66d9ef>out</span> <span style=color:#66d9ef>vec2</span> uv0;
</span></span><span style=display:flex><span><span style=color:#66d9ef>out</span> <span style=color:#66d9ef>vec3</span> normal0;
</span></span><span style=display:flex><span><span style=color:#66d9ef>out</span> <span style=color:#66d9ef>vec3</span> fragPos0;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>uniform</span> mat4 proj;
</span></span><span style=display:flex><span><span style=color:#66d9ef>uniform</span> mat4 view;
</span></span><span style=display:flex><span><span style=color:#66d9ef>uniform</span> mat4 model;
</span></span><span style=display:flex><span><span style=color:#66d9ef>uniform</span> <span style=color:#66d9ef>float</span> tweenFactor;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> main() {
</span></span><span style=display:flex><span>    uv0 <span style=color:#f92672>=</span> texCoord;
</span></span><span style=display:flex><span>    fragColor0 <span style=color:#f92672>=</span> vertexColor;
</span></span><span style=display:flex><span>    normal0 <span style=color:#f92672>=</span> mat3(model) <span style=color:#f92672>*</span> normalize(normal.xyz);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>vec4</span> basePos <span style=color:#f92672>=</span> <span style=color:#66d9ef>vec4</span>(mix(vertexPos.xyz, nextVertexPos.xyz, tweenFactor), <span style=color:#ae81ff>1.0</span>);
</span></span><span style=display:flex><span>    gl_Position <span style=color:#f92672>=</span> proj <span style=color:#f92672>*</span> view <span style=color:#f92672>*</span> model <span style=color:#f92672>*</span> basePos;
</span></span><span style=display:flex><span>    fragPos0 <span style=color:#f92672>=</span> gl_Position.xyz;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-glsl data-lang=glsl><span style=display:flex><span><span style=color:#75715e>// icon.frag</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#version 330 core</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define MAX_NUM_TOTAL_LIGHTS 3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span> <span style=color:#66d9ef>vec2</span> uv0;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span> <span style=color:#66d9ef>vec4</span> fragColor0;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span> <span style=color:#66d9ef>vec3</span> normal0;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span> <span style=color:#66d9ef>vec3</span> fragPos0;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>out</span> <span style=color:#66d9ef>vec4</span> fragColor;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> Light {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>vec4</span> pos;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>vec4</span> color;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>uniform</span> <span style=color:#66d9ef>sampler2D</span> texture0;
</span></span><span style=display:flex><span><span style=color:#66d9ef>uniform</span> <span style=color:#66d9ef>vec4</span> ambient;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>uniform</span> Light lights[MAX_NUM_TOTAL_LIGHTS];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> main() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>vec3</span> normal <span style=color:#f92672>=</span> normalize(normal0);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>float</span> alpha <span style=color:#f92672>=</span> fragColor0.a;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>vec3</span> color <span style=color:#f92672>=</span> fragColor0.rgb <span style=color:#f92672>*</span> texture(texture0, uv0).rgb;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>vec3</span> diffuse <span style=color:#f92672>=</span> <span style=color:#66d9ef>vec3</span>(<span style=color:#ae81ff>0.0</span>, <span style=color:#ae81ff>0.0</span>, <span style=color:#ae81ff>0.0</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> MAX_NUM_TOTAL_LIGHTS; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>vec3</span> lightDir <span style=color:#f92672>=</span> normalize(lights[i].pos.xyz <span style=color:#f92672>-</span> fragPos0);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>float</span> diff <span style=color:#f92672>=</span> max(dot(lightDir, normal), <span style=color:#ae81ff>0.0</span>);
</span></span><span style=display:flex><span>        diffuse <span style=color:#f92672>+=</span> diff <span style=color:#f92672>*</span> lights[i].color.rgb;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    color <span style=color:#f92672>=</span> (ambient.rgb <span style=color:#f92672>+</span> diffuse) <span style=color:#f92672>*</span> color;
</span></span><span style=display:flex><span>    fragColor <span style=color:#f92672>=</span> <span style=color:#66d9ef>vec4</span>(color, alpha);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>最终效果：</p><p><img loading=lazy src=/static/imgs/posts/2023-10-09-rendering-ps2-3d-icon/7.gif alt></p><h2 id=06-尾声>06 尾声<a hidden class=anchor aria-hidden=true href=#06-尾声>#</a></h2><p>所有代码均可在 <a href=https://github.com/caol64/ps2mc-browser>https://github.com/caol64/ps2mc-browser</a> 下载到。在我的第一篇文章中，我也提到了这个系列的创作初衷：为了纪念逝去的青春，以及对技术永不磨灭的热情。</p><h2 id=07-参考文献>07 参考文献<a hidden class=anchor aria-hidden=true href=#07-参考文献>#</a></h2><ul><li><a href=https://www.ps2savetools.com/documents/iconsys-format/>gothi - icon.sys format</a></li><li><a href=http://www.csclub.uwaterloo.ca:11068/mymc/ps2icon-0.5.pdf>Martin Akesson - PS2 Icon Format v0.5</a></li><li><a href=https://git.sr.ht/~thestr4ng3r/mymcplus>Florian Märkl - mymcplus</a></li><li><a href=https://www.ps2savetools.com/ps2memcardformat.html>Ross Ridge - PlayStation 2 Memory Card File System</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://babyno.top/tags/playstation2/>Playstation2</a></li><li><a href=https://babyno.top/tags/python/>Python</a></li><li><a href=https://babyno.top/tags/opengl/>OpenGL</a></li></ul><nav class=paginav><a class=prev href=https://babyno.top/posts/2023/10/rle-algorithm-in-ps2/><span class=title>« Prev</span><br><span>RLE算法在PS2中的应用</span></a>
<a class=next href=https://babyno.top/posts/2023/10/parsing-ps2-3d-icon/><span class=title>Next »</span><br><span>解析PS2游戏存档3D图标</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://babyno.top/>路边的阿不</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>